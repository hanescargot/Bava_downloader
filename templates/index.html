<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BaVa Downloader</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo/logo_trp.png') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #f0ecf8;
        --surface: #faf9fd;
        --surface2: #f4f1fb;
        --border: #e2daf2;
        --border-strong: #c9bfed;
        --text: #2d2540;
        --text-muted: #8b7faa;
        --text-subtle: #b5acd0;
        --accent-lavender: #b09ee8;
        --accent-rose: #f0a5c6;
        --accent-mint: #8ee3c8;
        --accent-sky: #93d4f5;
        --accent-peach: #f5bfa0;
        --accent-lilac: #d4b8f0;
        --green: #5dc99a;
        --red: #e87a8a;
        --shadow-sm: 0 2px 8px rgba(120, 100, 180, 0.08);
        --shadow-md: 0 4px 20px rgba(120, 100, 180, 0.12);
        --shadow-lg: 0 8px 40px rgba(120, 100, 180, 0.16);
        --radius-sm: 10px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-xl: 32px;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Outfit', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 32px 16px 64px;
        background-image:
          radial-gradient(ellipse 600px 400px at 10% 0%, rgba(176, 158, 232, 0.18) 0%, transparent 70%),
          radial-gradient(ellipse 500px 400px at 90% 100%, rgba(142, 227, 200, 0.15) 0%, transparent 70%),
          radial-gradient(ellipse 400px 300px at 80% 10%, rgba(147, 212, 245, 0.12) 0%, transparent 70%);
      }

      .app {
        width: min(760px, 100%);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* Header */
      .header {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 28px 32px;
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        animation: fadeUp 0.5s ease both;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .logo-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: #fff;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(120, 100, 180, 0.2);
        flex-shrink: 0;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .header-titles h1 {
        font-size: 1.45rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        line-height: 1.2;
        color: var(--text);
      }

      .header-titles p {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 500;
        margin-top: 2px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .badge-version {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-family: 'DM Mono', monospace;
      }

      .badge-lab {
        background: linear-gradient(135deg, #e8e0ff, #fce0ef);
        border: 1px solid var(--border);
        color: var(--accent-lavender);
      }

      /* Card */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-sm);
        animation: fadeUp 0.5s ease both;
      }

      .card:nth-child(2) { animation-delay: 0.05s; }
      .card:nth-child(3) { animation-delay: 0.10s; }

      .card-label {
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-label::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      /* Input */
      .field-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 8px;
        display: block;
      }

      input[type="url"],
      input[type="text"],
      select {
        width: 100%;
        background: var(--surface2);
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 11px 14px;
        font-size: 0.9rem;
        font-family: 'Outfit', sans-serif;
        color: var(--text);
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input[type="url"]:focus,
      input[type="text"]:focus,
      select:focus {
        border-color: var(--accent-lavender);
        box-shadow: 0 0 0 3px rgba(176, 158, 232, 0.15);
      }

      input::placeholder { color: var(--text-subtle); }

      .input-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
      }

      .hint-text {
        font-size: 0.75rem;
        color: var(--text-subtle);
        margin-top: 6px;
        font-family: 'DM Mono', monospace;
      }

      /* Platform chips */
      .platforms {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin: 16px 0;
      }

      .platform {
        background: var(--surface2);
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 10px 8px;
        text-align: center;
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.2s;
        user-select: none;
      }

      .platform:hover {
        border-color: var(--accent-lavender);
        color: var(--text);
        transform: translateY(-1px);
      }

      .platform.active {
        background: linear-gradient(135deg, #ede8fb, #fce8f4);
        border-color: var(--accent-lavender);
        color: var(--text);
        box-shadow: 0 2px 10px rgba(176, 158, 232, 0.25);
      }

      .platform-icon { display: block; font-size: 1.1rem; margin-bottom: 4px; }

      /* Format row */
      .format-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 12px;
      }

      /* Buttons */
      .btn {
        border: none;
        border-radius: var(--radius-sm);
        padding: 11px 18px;
        font-size: 0.88rem;
        font-weight: 700;
        font-family: 'Outfit', sans-serif;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 7px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent-lavender), #c5aaf5);
        color: white;
        width: 100%;
        padding: 13px;
        margin-top: 14px;
        font-size: 0.92rem;
        box-shadow: 0 4px 16px rgba(176, 158, 232, 0.35);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(176, 158, 232, 0.45);
      }

      .btn-primary:active { transform: translateY(0); }

      .btn-secondary {
        background: var(--surface2);
        border: 1.5px solid var(--border);
        color: var(--text-muted);
        font-size: 0.82rem;
        white-space: nowrap;
      }

      .btn-secondary:hover {
        border-color: var(--accent-lavender);
        color: var(--text);
      }

      .btn-release {
        text-decoration: none;
        padding: 8px 12px;
      }

      .btn-green {
        background: linear-gradient(135deg, var(--green), #4fc89a);
        color: white;
        width: 100%;
        padding: 13px;
        margin-top: 12px;
        box-shadow: 0 4px 16px rgba(93, 201, 154, 0.3);
      }

      .btn-green:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(93, 201, 154, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      /* Status messages */
      .status-msg {
        font-size: 0.78rem;
        font-weight: 600;
        margin-top: 7px;
        min-height: 18px;
        transition: color 0.2s;
      }

      /* Loader */
      .loader {
        display: none;
        text-align: center;
        padding: 16px;
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 500;
      }

      .loader.active { display: flex; align-items: center; justify-content: center; gap: 10px; }

      .spinner {
        width: 18px;
        height: 18px;
        border: 2.5px solid var(--border);
        border-top-color: var(--accent-lavender);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      /* Error */
      .error-msg {
        display: none;
        background: rgba(232, 122, 138, 0.1);
        border: 1px solid rgba(232, 122, 138, 0.3);
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--red);
        margin-top: 10px;
      }

      .error-msg.active { display: block; }

      /* Result panel */
      .result-panel {
        display: none;
        background: linear-gradient(135deg, #f0ecff, #fce8f4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-top: 14px;
        animation: fadeIn 0.3s ease;
      }

      .result-panel.active { display: block; }

      .result-title {
        font-size: 0.98rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .result-meta {
        font-size: 0.78rem;
        color: var(--text-muted);
        font-family: 'DM Mono', monospace;
        margin-bottom: 12px;
      }

      /* Download items */
      .downloads-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 16px;
      }

      .download-item {
        background: var(--surface2);
        border: 1.5px solid var(--border);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        animation: fadeUp 0.25s ease;
      }

      .download-item-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .download-item-title {
        font-size: 0.88rem;
        font-weight: 600;
        color: var(--text);
        line-height: 1.3;
      }

      .download-item-meta {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 4px;
      }

      .chip {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .chip-platform { background: #e8e0ff; color: #7b68cc; }
      .chip-format { background: #d8f5ee; color: #2e9b74; }

      /* Progress */
      .progress-wrap {
        background: var(--border);
        border-radius: 999px;
        height: 5px;
        overflow: hidden;
        margin: 10px 0 8px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-lavender), var(--accent-mint));
        border-radius: 999px;
        transition: width 0.3s ease;
      }

      .download-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .download-status-text {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-muted);
      }

      .pct-text {
        font-size: 0.75rem;
        font-family: 'DM Mono', monospace;
        color: var(--text-muted);
      }

      .link-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: linear-gradient(135deg, var(--accent-lavender), #c5aaf5);
        color: white;
        border: none;
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.72rem;
        font-weight: 700;
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.2s;
      }

      .link-btn:hover { opacity: 0.85; transform: translateY(-1px); }

      /* Animations */
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* Divider */
      .divider {
        height: 1px;
        background: var(--border);
        margin: 16px 0;
      }

      @media (max-width: 500px) {
        .platforms { grid-template-columns: repeat(2, 1fr); }
        .format-row { grid-template-columns: 1fr; }
        .header { padding: 20px; }
        .header-right { width: 100%; justify-content: flex-end; flex-wrap: wrap; }
        .card { padding: 18px; }
      }
    </style>
  </head>
  <body>
    <div class="app">

      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <div class="logo-icon">
            <img src="{{ url_for('static', filename='images/logo/1024_trp.png') }}" alt="BaVa Î°úÍ≥†" />
          </div>
          <div class="header-titles">
            <h1 id="app-name">BaVa Downloader</h1>
            <p>SNS ÎèôÏòÅÏÉÅ Î¨¥Î£å Îã§Ïö¥Î°úÎìú</p>
          </div>
        </div>
        <div class="header-right">
          <a
            class="btn btn-secondary btn-release"
            id="release-link"
            href="{{ release_info.asset_download_url if release_info else '#' }}"
            target="_blank"
            rel="noopener noreferrer"
            {% if not release_info %}hidden{% endif %}
          >
            ÏµúÏã† Ïï± Îã§Ïö¥Î°úÎìú
          </a>
          <span class="badge badge-lab">Studio</span>
          <span class="badge badge-version" id="app-version">v{{ app_version }}</span>
        </div>
      </header>

      <!-- Download Path -->
      <div class="card">
        <div class="card-label">Ï†ÄÏû• Í≤ΩÎ°ú</div>
        <span class="field-label">Îã§Ïö¥Î°úÎìú Ìè¥Îçî</span>
        <div class="input-row">
          <input type="text" id="download-path" placeholder="/Users/you/Downloads/BaVa" />
          <button class="btn btn-secondary" id="browse-path-btn" type="button">Ìè¥Îçî Ï∞æÍ∏∞</button>
          <button class="btn btn-secondary" id="save-path-btn" type="button">Ï†ÄÏû•</button>
        </div>
        <p class="hint-text" id="default-path-hint">Í∏∞Î≥∏Í∞í: /tmp/downloads</p>
        <p class="status-msg" id="path-status"></p>
      </div>

      <!-- Main download card -->
      <div class="card">
        <div class="card-label">Îã§Ïö¥Î°úÎìú</div>

        <!-- URL input -->
        <span class="field-label">ÎèôÏòÅÏÉÅ URL</span>
        <input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." />

        <!-- Platform selector -->
        <div class="platforms">
          <div class="platform active" data-platform="youtube">
            <span class="platform-icon">‚ñ∂</span>Ïú†ÌäúÎ∏å
          </div>
          <div class="platform" data-platform="tiktok">
            <span class="platform-icon">‚ô™</span>Ìã±ÌÜ°
          </div>
          <div class="platform" data-platform="instagram">
            <span class="platform-icon">‚óà</span>Ïù∏Ïä§ÌÉÄ
          </div>
          <div class="platform" data-platform="facebook">
            <span class="platform-icon">‚¨°</span>ÌéòÏù¥Ïä§Î∂Å
          </div>
        </div>

        <!-- Format -->
        <div class="format-row">
          <div>
            <span class="field-label">ÌòïÏãù</span>
            <select id="format">
              <option value="mp4">MP4 ‚Äî ÎπÑÎîîÏò§</option>
              <option value="mp3">MP3 ‚Äî Ïò§ÎîîÏò§</option>
              <option value="webm">WebM ‚Äî ÎπÑÎîîÏò§</option>
            </select>
          </div>
          <div>
            <span class="field-label">ÌôîÏßà</span>
            <select id="quality">
              <option value="best">ÏµúÍ≥† ÌôîÏßà</option>
              <option value="1080p">1080p</option>
              <option value="720p">720p</option>
              <option value="480p">480p</option>
            </select>
          </div>
        </div>

        <!-- Fetch info button -->
        <button class="btn btn-primary" id="download-btn" type="button">
          <span>üîç</span> Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        </button>

        <!-- Loading -->
        <div class="loader" id="loader">
          <div class="spinner"></div>
          <span>Î∂ÑÏÑù Ï§ë...</span>
        </div>

        <!-- Error -->
        <p class="error-msg" id="error-message"></p>

        <!-- Result panel -->
        <div class="result-panel" id="result-container">
          <div class="result-title" id="video-title"></div>
          <div class="result-meta" id="video-info"></div>

          <span class="field-label">Ï†ÄÏû• ÌååÏùºÎ™Ö</span>
          <input type="text" id="file-name" placeholder="ÎèôÏòÅÏÉÅ Ï†úÎ™©" />

          <button class="btn btn-green" id="download-link" type="button">
            <span>‚¨á</span> Îã§Ïö¥Î°úÎìú
          </button>
        </div>

        <!-- Downloads list -->
        <div class="downloads-list" id="downloads-list"></div>
      </div>

    </div><!-- .app -->

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const API_BASE_URL =
          window.__APP_API_BASE_URL ||
          (window.location.protocol === "file:" ? "http://127.0.0.1:5252" : window.location.origin);

        const pathInput = document.getElementById("download-path");
        const browsePathBtn = document.getElementById("browse-path-btn");
        const savePathBtn = document.getElementById("save-path-btn");
        const pathStatus = document.getElementById("path-status");
        const defaultPathHint = document.getElementById("default-path-hint");
        const appVersion = document.getElementById("app-version");
        const appName = document.getElementById("app-name");
        const releaseLink = document.getElementById("release-link");

        const urlInput = document.getElementById("video-url");
        const formatInput = document.getElementById("format");
        const qualityInput = document.getElementById("quality");
        const fileNameInput = document.getElementById("file-name");
        const downloadBtn = document.getElementById("download-btn");
        const finalDownloadBtn = document.getElementById("download-link");
        const loader = document.getElementById("loader");
        const errorMessage = document.getElementById("error-message");
        const resultContainer = document.getElementById("result-container");
        const videoTitle = document.getElementById("video-title");
        const videoInfo = document.getElementById("video-info");
        const downloadsList = document.getElementById("downloads-list");

        let currentPlatform = "youtube";

        const platformLabels = {
          youtube: "Ïú†ÌäúÎ∏å", tiktok: "Ìã±ÌÜ°", instagram: "Ïù∏Ïä§ÌÉÄÍ∑∏Îû®", facebook: "ÌéòÏù¥Ïä§Î∂Å"
        };

        function setPathStatus(msg, isError) {
          pathStatus.textContent = msg;
          pathStatus.style.color = isError ? "#e87a8a" : "#5dc99a";
        }

        function setError(msg) {
          errorMessage.textContent = msg;
          errorMessage.classList.add("active");
        }

        function clearError() {
          errorMessage.textContent = "";
          errorMessage.classList.remove("active");
        }

        function mapDownloadErrorMessage(msg) {
          const text = String(msg || "");
          if (
            text.includes("ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§") ||
            text.includes("ÌååÏùº Îã§Ïö¥Î°úÎìú ÌõÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§")
          ) {
            return "Îã§Ïö¥Î°úÎìú Î∂àÍ∞ÄÎä•Ìïú ÏòÅÏÉÅ Ìè¨Îß∑ÏûÖÎãàÎã§.";
          }
          return text || "Îã§Ïö¥Î°úÎìú Ïã§Ìå®";
        }

        function showLoader() {
          loader.classList.add("active");
          downloadBtn.style.opacity = "0.5";
        }

        function hideLoader() {
          loader.classList.remove("active");
          downloadBtn.style.opacity = "1";
        }

        function formatDuration(seconds) {
          if (!seconds) return "Ïïå Ïàò ÏóÜÏùå";
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m}:${String(s).padStart(2, "0")}`;
        }

        function formatDate(d) {
          if (!d) return "Ïïå Ïàò ÏóÜÏùå";
          return d.replace(/(\d{4})(\d{2})(\d{2})/, "$1-$2-$3");
        }

        async function loadSettings() {
          try {
            const res = await fetch(`${API_BASE_URL}/api/settings`);
            const data = await res.json();
            if (!data.success) { setPathStatus("ÏÑ§Ï†ï Ï°∞Ìöå Ïã§Ìå®", true); return; }
            pathInput.value = data.data.download_path || "";
            defaultPathHint.textContent = `Í∏∞Î≥∏Í∞í: ${data.data.default_download_path || "/tmp/downloads"}`;
            if (data.data.version) appVersion.textContent = `v${data.data.version}`;
            if (data.data.app_name) appName.textContent = data.data.app_name;
            if (data.data.release && data.data.release.asset_download_url) {
              releaseLink.href = data.data.release.asset_download_url;
              releaseLink.hidden = false;
            } else {
              releaseLink.hidden = true;
            }
            setPathStatus("Í≤ΩÎ°úÎ•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.", false);
          } catch (_) {
            setPathStatus("ÏÑ§Ï†ï API Ïó∞Í≤∞ Ïã§Ìå®", true);
            releaseLink.hidden = true;
          }
        }

        browsePathBtn.addEventListener("click", async function () {
          browsePathBtn.disabled = true;
          const orig = browsePathBtn.textContent;
          browsePathBtn.textContent = "Ï∞æÎäî Ï§ë";
          try {
            const res = await fetch(`${API_BASE_URL}/api/browse-folder`);
            const data = await res.json();
            if (!res.ok || data.error) {
              setPathStatus(data.error || "Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
              alert("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§");
              return;
            }
            if (data.success && data.path) {
              pathInput.value = data.path;
              setPathStatus(`Ï∞æÏùå ‚Äî ${data.path}`, false);
            }
          } catch (_) {
            setPathStatus("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
            alert("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§");
          } finally {
            browsePathBtn.disabled = false;
            browsePathBtn.textContent = orig;
          }
        });

        savePathBtn.addEventListener("click", async function () {
          const p = pathInput.value.trim();
          if (!p) { setPathStatus("Í≤ΩÎ°úÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", true); return; }
          savePathBtn.disabled = true;
          const orig = savePathBtn.textContent;
          savePathBtn.textContent = "Í≤ÄÏ¶ù Ï§ë";
          try {
            const validateRes = await fetch(`${API_BASE_URL}/api/validate-path`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ download_path: p }),
            });
            const validateData = await validateRes.json();
            if (!validateRes.ok || validateData.error || !validateData.success) {
              setPathStatus("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
              return;
            }

            savePathBtn.textContent = "Ï†ÄÏû• Ï§ë";
            const res = await fetch(`${API_BASE_URL}/api/settings`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ download_path: p }),
            });
            const data = await res.json();
            if (!res.ok || data.error) {
              setPathStatus("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
            } else {
              pathInput.value = data.download_path;
              setPathStatus(`Ï†ÄÏû•Îê® ‚Äî ${data.download_path}`, false);
            }
          } catch (_) {
            setPathStatus("Ìè¥Îçî Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
          } finally {
            savePathBtn.disabled = false;
            savePathBtn.textContent = orig;
          }
        });

        document.querySelectorAll(".platform").forEach((btn) => {
          btn.addEventListener("click", function () {
            document.querySelectorAll(".platform").forEach((x) => x.classList.remove("active"));
            this.classList.add("active");
            currentPlatform = this.dataset.platform;
            const placeholders = {
              youtube: "https://www.youtube.com/watch?v=...",
              tiktok: "https://www.tiktok.com/@username/video/...",
              instagram: "https://www.instagram.com/reel/...",
              facebook: "https://www.facebook.com/watch?v=...",
            };
            urlInput.placeholder = placeholders[currentPlatform];
            resultContainer.classList.remove("active");
            clearError();
          });
        });

        downloadBtn.addEventListener("click", async function () {
          const videoUrl = urlInput.value.trim();
          if (!videoUrl) { setError("URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; }
          clearError();
          showLoader();
          resultContainer.classList.remove("active");
          try {
            const res = await fetch(`${API_BASE_URL}/api/video-info`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: videoUrl, platform: currentPlatform }),
            });
            const data = await res.json();
            hideLoader();
            if (!res.ok || data.error || !data.success) {
              setError(data.error || "ÎèôÏòÅÏÉÅ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
              return;
            }
            const info = data.data;
            videoTitle.textContent = info.title || "Ï†úÎ™© ÏóÜÏùå";
            videoInfo.textContent = `‚è± ${formatDuration(info.duration)}  ¬∑  üìÖ ${formatDate(info.upload_date)}`;
            fileNameInput.value = info.suggested_filename || info.title || "video";
            resultContainer.classList.add("active");
          } catch (_) {
            hideLoader();
            setError("ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          }
        });

        finalDownloadBtn.addEventListener("click", async function () {
          const videoUrl = urlInput.value.trim();
          const format = formatInput.value;
          const quality = qualityInput.value;
          const filename = fileNameInput.value.trim();
          if (!videoUrl) { setError("URLÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; }

          finalDownloadBtn.disabled = true;
          const oldText = finalDownloadBtn.innerHTML;
          finalDownloadBtn.innerHTML = "‚è≥ Ï§ÄÎπÑ Ï§ë...";

          const item = document.createElement("div");
          item.className = "download-item";
          item.innerHTML = `
            <div class="download-item-header">
              <div>
                <div class="download-item-title">${videoTitle.textContent}</div>
                <div class="download-item-meta">
                  <span class="chip chip-platform">${platformLabels[currentPlatform]}</span>
                  <span class="chip chip-format">${format.toUpperCase()}</span>
                  <span class="chip chip-format">${quality.toUpperCase()}</span>
                </div>
              </div>
            </div>
            <div class="progress-wrap"><div class="progress-bar" style="width:5%"></div></div>
            <div class="download-footer">
              <span class="download-status-text">ÏöîÏ≤≠ Ï§ë...</span>
              <span class="pct-text">5%</span>
            </div>
          `;
          downloadsList.prepend(item);

          const bar = item.querySelector(".progress-bar");
          const pct = item.querySelector(".pct-text");
          const statusText = item.querySelector(".download-status-text");

          let progress = 5;
          const timer = setInterval(() => {
            if (progress < 90) {
              progress += Math.floor(Math.random() * 8) + 1;
              if (progress > 90) progress = 90;
              bar.style.width = `${progress}%`;
              pct.textContent = `${progress}%`;
            }
          }, 350);

          try {
            const res = await fetch(`${API_BASE_URL}/api/download`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: videoUrl, format, quality, platform: currentPlatform, filename }),
            });
            const data = await res.json();
            clearInterval(timer);

            if (!res.ok || data.error || !data.success) {
              statusText.textContent = mapDownloadErrorMessage(data.error);
              statusText.style.color = "#e87a8a";
              bar.style.background = "#e87a8a";
              return;
            }

            bar.style.width = "100%";
            pct.textContent = "100%";
            statusText.textContent = "ÏôÑÎ£å";
            statusText.style.color = "#5dc99a";

            let downloadUrl = data.download_url;
            if (downloadUrl && downloadUrl.startsWith("/")) downloadUrl = `${API_BASE_URL}${downloadUrl}`;

            if (downloadUrl) {
              const link = document.createElement("a");
              link.className = "link-btn";
              link.href = downloadUrl;
              link.target = "_self";
              link.textContent = "‚¨á ÌååÏùº Ï†ÄÏû•";
              item.querySelector(".download-footer").appendChild(link);
              try {
                const fileRes = await fetch(downloadUrl);
                if (!fileRes.ok) {
                  let reason = "";
                  try {
                    const errData = await fileRes.json();
                    reason = errData && errData.error ? errData.error : "";
                  } catch (_) {
                    reason = "";
                  }
                  throw new Error(reason || "ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§");
                }

                const blob = await fileRes.blob();
                const saveUrl = URL.createObjectURL(blob);
                const saveLink = document.createElement("a");
                saveLink.href = saveUrl;
                saveLink.download = data.filename || "video";
                saveLink.style.display = "none";
                document.body.appendChild(saveLink);
                saveLink.click();
                saveLink.remove();
                URL.revokeObjectURL(saveUrl);
              } catch (err) {
                statusText.textContent = mapDownloadErrorMessage(err.message);
                statusText.style.color = "#e87a8a";
                bar.style.background = "#e87a8a";
              }
            }
          } catch (_) {
            clearInterval(timer);
            statusText.textContent = "ÏöîÏ≤≠ Ïã§Ìå®";
            statusText.style.color = "#e87a8a";
            bar.style.background = "#e87a8a";
          } finally {
            finalDownloadBtn.disabled = false;
            finalDownloadBtn.innerHTML = oldText;
          }
        });

        loadSettings();
      });
    </script>
  </body>
</html>
